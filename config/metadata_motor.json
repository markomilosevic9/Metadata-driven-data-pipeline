{
  "processing_mode": "incremental",
  "batch_config": {
    "input_pattern": "s3a://input-data/batch-{date}/input*.jsonl",
    "date_format": "%Y-%m-%d",
    "batch_metadata_columns": [
      "source_batch",
      "batch_date",
      "processed_run_id"
    ]
  },
  "dataflows": [
    {
      "name": "motor-ingestion",
      "sources": [
        {
          "name": "policy_inputs",
          "path": "s3a://input-data/batch-{date}/input*.jsonl",
          "format": "json",
          "required": true,
          "schema": {
            "type": "struct",
            "fields": [
              {
                "name": "policy_number",
                "type": "string",
                "nullable": false,
                "metadata": {
                  "description": "Unique policy identifier"
                }
              },
              {
                "name": "driver_age",
                "type": "integer",
                "nullable": true,
                "metadata": {
                  "description": "Driver age in years"
                }
              },
              {
                "name": "plate_number",
                "type": "string",
                "nullable": false,
                "metadata": {
                  "description": "Vehicle plate number"
                }
              }
            ]
          },
          "schema_enforcement": {
            "enabled": true
          },
          "options": {"multiLine": false}
        }
      ],
      "transformations": [
        {
          "name": "add_batch_metadata",
          "type": "add_fields",
          "params": {
            "input": "policy_inputs",
            "addFields": [
              {"name": "source_batch", "function": "batch_id"},
              {"name": "batch_date", "function": "batch_date"},
              {"name": "processed_run_id", "function": "run_id"}
            ]
          }
        },
        {
          "name": "validation",
          "type": "validate_fields",
          "params": {
            "input": "add_batch_metadata",
            "validations": [
              {
                "field": "plate_number",
                "rules": [
                  "notNull",
                  "notEmpty",
                  {"name": "regex", "params": "^[A-Z0-9-]+$"}
                ]
              },
              {
                "field": "driver_age",
                "rules": [
                  "notNull",
                  {"name": "minValue", "params": 18}
                ]
              },
              {
                "field": "policy_number",
                "rules": ["notNull"]
              }
            ]
          }
        },
        {
          "name": "add_ingestion_dt_ok",
          "type": "add_fields",
          "params": {
            "input": "validation_ok",
            "addFields": [
              {"name": "ingestion_dt", "function": "current_timestamp"}
            ]
          }
        },
        {
          "name": "add_ingestion_dt_ko",
          "type": "add_fields",
          "params": {
            "input": "validation_ko",
            "addFields": [
              {"name": "ingestion_dt", "function": "current_timestamp"}
            ]
          }
        }
      ],
      "sinks": [
        {
          "input": "add_ingestion_dt_ok",
          "name": "raw-ok",
          "path": "s3a://motor-policy-ok/batch-{date}/output",
          "format": "json",
          "saveMode": "overwrite"
        },
        {
          "input": "add_ingestion_dt_ko",
          "name": "raw-ko",
          "path": "s3a://motor-policy-ko/batch-{date}/output",
          "format": "json",
          "saveMode": "overwrite"
        }
      ]
    }
  ],
  "consolidation": {
    "enabled": true,
    "ok_records": {
      "input_pattern": "s3a://motor-policy-ok/batch-*/output/*.json",
      "output_path": "s3a://motor-policy-ok-consolidated/output",
      "deduplication": {
        "enabled": true,
        "key_column": "policy_number",
        "order_by": "batch_date",
        "order_direction": "DESC"
      }
    }
  }
}